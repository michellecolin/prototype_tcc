<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">

    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=1.0, maximum-scale=1.0"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">

    <link href="css/canvas-elements.css" rel="stylesheet" type="text/css" />
    <link href="css/general.css" rel="stylesheet" type="text/css" />

    <META http-equiv="Cache-Control" content="no-cache">
    <META http-equiv="Pragma" content="no-cache">
    <META http-equiv="Expires" content="0">

    <title>Action gestures</title>
    <script src="scripts/libs/fingers.js"></script>
    <script type="text/javascript" src="scripts/libs/canvas.text.js"></script>
    <script type="text/javascript" src="scripts/libs/jquery.min.js"></script>
    <script type="text/javascript" src="scripts/libs/dollar.js"></script>
    <script src="scripts/diagram.js"></script>
    <script src="scripts/canvas-logic.js"></script>
    <script type="text/javascript" src="scripts/gestureRecognizer.js"></script>
</head>
<body class="lock-screen" onload="onLoadEvent()"> <!-- start gesture recognition -->
    <div class="toolbox">
        <div class="item" id="actor" data-action="insert"><img class="inner" src="img/actor.png"/></div>
        <div class="item" id="ellipse" data-action="insert"><img class="inner" src="img/ellipse.png"></div>
        <div class="item" id="package" data-action="insert"><img class="inner" src="img/package.png"></div>
        <div class="item" id="boundary" data-action="insert"><img class="inner" src="img/boundary.png"></div>
        <div class="item" id="note" data-action="insert"><img class="inner" src="img/note.png"></div>
        <div style="clear:both"></div>
    </div>

    <div class="modal">
        <div class="error">This axtion is not</div>
    </div>

    <div class="hold-inserted-elements">
        <div class="selected-elements actor slideLeft">
            <img class="inner" src="img/actor.png"/>
            <div class="ammount">3</div>
        </div>
        <div class="selected-elements ellipse slideLeft">
            <img class="inner" src="img/ellipse.png"/>
            <div class="ammount">3</div>
        </div>
        <div class="selected-elements package slideLeft">
            <img class="inner" src="img/package.png"/>
            <div class="ammount">3</div>
        </div>
        <div class="selected-elements boundary slideLeft">
            <img class="inner" src="img/boundary.png"/>
            <div class="ammount">3</div>
        </div>
        <div class="selected-elements note slideLeft">
            <img class="inner" src="img/note.png"/>
            <div class="ammount">3</div>
        </div>
    </div>

    <canvas id="myCanvas" width="2000px" height="2000px"
        oncontextmenu="return false;">
        <span style="background-color:#ffff88;">The &lt;canvas&gt; element is not supported by this browser.</span>
    </canvas>

<script>
    var elementsToBeAdded = {};
    document.body.style.webkitTouchCallout='none';

    window.oncontextmenu = function(event) {
         event.preventDefault();
         event.stopPropagation();
         return false;
    };
    
    function listenSwipe(pElement, pLabelElement) {
        var finger = new Fingers(pElement);
        finger.addGesture(Fingers.gesture.Swipe, {
            nbFingers: 2
        }).addHandler(function(pEventType, pData, pFingers) {
            updateLabel(pLabelElement, "Swipe " + pData.direction + "<br/>Velocity: "+ pData.velocity.toFixed(2) + " px/ms");
        });
    }

    function listenHoldOneFinger(pElement, pLabelElement) {
        var finger = new Fingers(pElement);
        finger.addGesture(Fingers.gesture.Hold, {
            nbFingers: 1
        }).addHandler(function(pEventType, pData, pFingers) {
            if (pElement.dataset.action === "insert") {
                Diagram.actionStarted("insert", elementsToBeAdded);
                addDiagramElements(pElement.id);  
                updateImage(pLabelElement, pElement.id); 
            }              
        });
    };

    function listenHoldTwoFinger(pElement, pLabelElement) {
        var finger = new Fingers(pElement);
        finger.addGesture(Fingers.gesture.Hold, {
            nbFingers: 2
        }).addHandler(function(pEventType, pData, pFingers) {
            updateLabel(pLabelElement, "Hold " + pFingers.length);
        });
    };


    function listenHoldThreeFinger(pElement, pLabelElement) {
        var finger = new Fingers(pElement);
        finger.addGesture(Fingers.gesture.Hold, {
            nbFingers: 3
        }).addHandler(function(pEventType, pData, pFingers) {
            updateLabel(pLabelElement, "");
        });
    };


    function listenHold(pElement, pLabelElement, pNbFingers) {
        var finger = new Fingers(pElement);
        finger.addGesture(Fingers.gesture.Hold, {
            nbFingers: pNbFingers
        }).addHandler(function(pEventType, pData, pFingers) {
            updateLabel(pLabelElement, "Hold");
        });
    };

    function listenTap(pElement, pLabelElement) {
        var finger = new Fingers(pElement);
        finger.addGesture(Fingers.gesture.Tap, {
            nbFingers: 1
        }).addHandler(function(pEventType, pData, pFingers) {
            if (pData.nbTap === 1) {
                updateLabel(pLabelElement, "Tap<br/>" + pData.nbTap + "x");
            }
        });
    };

    function listenDoubleTap(pElement, pLabelElement) {
        var finger = new Fingers(pElement);
        finger.addGesture(Fingers.gesture.Tap, {
            nbFingers: 1
        }).addHandler(function(pEventType, pData, pFingers) {
            if (pData.nbTap === 2) {
                updateLabel(pLabelElement, "Tap<br/>" + pData.nbTap + "x");
            }
        });
    };

    function updateLabel(pLabelElement, pNewLabel) {
        clearTimeout(pLabelElement.__timeout__);
        if(!pLabelElement.__originalLabel__) { pLabelElement.__originalLabel__ = pLabelElement.innerHTML; }
        pLabelElement.innerHTML = pNewLabel;
        pLabelElement.__timeout__ = setTimeout(function() {
            pLabelElement.innerHTML = pLabelElement.__originalLabel__;
        }, 2000);
    };

    function updateImage(pLabelElement, elId) {
        var originalImg = pLabelElement.currentSrc;
        var selectedImg = originalImg.slice(0,originalImg.length-4) + "_selected.png";
        pLabelElement.src = selectedImg; //Replace image
        clearTimeout(pLabelElement.__timeout__);
        pLabelElement.__timeout__ = setTimeout(function() {
            pLabelElement.src = originalImg;
            removeHighlit(elId);
        }, 700);
    };

    function addDiagramElements(elementId) {
        var divEl = document.getElementsByClassName("hold-inserted-elements")[0];
        divEl.style.display = 'block';
        var divEl = document.getElementsByClassName("selected-elements " + elementId)[0];
        
        if (!elementsToBeAdded[elementId]) {
            elementsToBeAdded[elementId] = 1;
            var length = Object.keys(elementsToBeAdded).length;
            switch(length) {
                case 1: 
                        break;
                case 2: divEl.style.marginLeft = '50px';
                        divEl.style.zIndex = '1';
                        break;
                case 3: divEl.style.marginLeft = '100px';
                        divEl.style.zIndex = '2';
                        break;
                case 4: divEl.style.marginLeft = '150px';
                        divEl.style.zIndex = '3';
                        break;
                case 5: divEl.style.marginLeft = '200px';
                        divEl.style.zIndex = '4';
                        break;
            }
        } else {
            elementsToBeAdded[elementId]++;
            divEl.className += " pulse";
        }

        divEl.children[1].innerHTML = elementsToBeAdded[elementId];
        divEl.style.display = 'block';
        divEl.children[1].style.backgroundColor = '#ff6a6a';
        
        var classes = divEl.className;
        if (classes.indexOf("pulse") !== -1) { //animation has already run one time
            //make it run again
            var elm = divEl
            var newone = elm.cloneNode(true);
            elm.parentNode.replaceChild(newone, elm);
        } 
    };

    function removeHighlit(elementId) {
        var divEl = document.getElementsByClassName("selected-elements " + elementId)[0];
        divEl.children[1].style.backgroundColor = '';
    };

    function cancelActionInsertElements() {
        var divEl = document.getElementsByClassName("hold-inserted-elements")[0];
        divEl.style.display = 'none';
        //clean child elements
        Array.from(divEl.children).forEach(function(el){
            el.style = '';
            el.style.display = 'none';
        });   
        resetElementsToBeAdded()         
    };

    function removeInsertElementsPanel() {
        var divEl = document.getElementsByClassName("hold-inserted-elements")[0];
        divEl.style.display = 'none';
        //clean child elements
        Array.from(divEl.children).forEach(function(el){
            el.style = '';
            el.style.display = 'none';
        });   
    };

    function resetElementsToBeAdded() {
        elementsToBeAdded = {}; 
    }

    function showErrorModal(msg) {
        $('.modal').css('display', 'table');
        $('.error').html(msg);

        setTimeout(function(){
           $('.modal').hide(); 
        },2000);
    }

    var toolbox = document.getElementsByClassName("toolbox");

    Array.from(toolbox[0].children).forEach(function(item) {
        if (item.id) {
            var item = document.getElementById(item.id);
            listenHoldOneFinger(item, item.querySelector(".inner"));
        }
    });

</script> 

</body>
</html>